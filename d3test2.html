<!DOCTYPE html>
<html>
<head>
<style>
div.tooltip {
  position: absolute;
  text-align: left;
  padding: 10px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  pointer-events: none;
}

div.modal-dialog.modal-lg {
    max-width: 1000px;
}
</style>
<!-- Bootstrap 4.0.0 libraries -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
<!-- Modal -->
<div class="modal fade" id="stackedBC" role="dialog">
<div class="modal-dialog modal-lg">

  <!-- Modal content-->
  <div class="modal-content">
    <div class="modal-header">
        <h4>Stacked Bar Charts</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
    </div>
    <div class="modal-body">
        <svg width="960" height="450"></svg>
    </div>
  </div>

</div>
</div>
<script>
    var svg = d3.select("svg"),
        margin = {
            top: 40,
            right: 20,
            bottom: 40,
            left: 50
        },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    var x = d3.scaleLinear().rangeRound([0, width]);

    var y = d3.scaleLinear()
        .rangeRound([height, 0]);

    var z = d3.scaleOrdinal(d3.schemeCategory10);

    d3.json("data.json").then(function(json) {
        var data = [];
        for (var i = 0, j = 0; i <= 480; i += 10, j++) {
            data.push({
                x: i,
                total: 0
            });
        }

        var keys = json.taskName;
        for (var i = 0; i < 3; i++) {
            for (var j = 0; j < 48; j++) {
                data[j][keys[i]] = json.utilization[0][0][i][j];
                data[j]["total"] += json.utilization[0][0][i][j];
            }
            data[j][keys[i]] = 0; // prevent error for the last column 480
        }

        //console.log(data);
        //data.sort(function(a, b) { return b.total - a.total; });
        x.domain([0, 480]); // data.map(function(d) { return d.x; }));
        y.domain([0, 1]); //.nice()
        z.domain(keys);

        var stacked = d3.stack().keys(keys)(data);
        //console.log(stacked);
        g.append("g")
            .selectAll("g")
            .data(d3.stack().keys(keys)(data))
            .enter().append("g")
            .attr("fill", function(d) {
                return z(d.key);
            })
            .selectAll("rect")
            .data(function(d) {
                return d;
            })
            .enter().append("rect")
            .attr("x", function(d) {
                return x(d.data.x) + 3;
            })
            .attr("y", function(d) {
                return y(d[1]);
            })
            .attr("height", function(d) {
                return y(d[0]) - y(d[1]);
            })
            .attr("width", 14); // x.bandwidth());

        g.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).ticks(48));

        g.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y).ticks(null, 's').tickFormat(function(d) {
                return d * 100;
            }))
            .append("text")
            .attr("x", 2)
            .attr("y", y(y.ticks().pop()) + 0.5)
            .attr("dy", "0.32em")
            .attr("fill", "#000")
            .attr("font-weight", "bold")
            .attr("text-anchor", "start");

        var legend = g.append("g")
            .attr("font-family", "sans-serif")
            .attr("font-size", 10)
            .attr("text-anchor", "end")
            .selectAll("g")
            .data(keys.slice().reverse())
            .enter().append("g")
            .attr("transform", function(d, i) {
                return "translate(0," + i * 20 + ")";
            });

        legend.append("rect")
            .attr("x", width - 19)
            .attr("width", 19)
            .attr("height", 19)
            .attr("fill", z);

        legend.append("text")
            .attr("x", width - 24)
            .attr("y", 9.5)
            .attr("dy", "0.32em")
            .text(function(d) {
                return d;
            });

        // text label for the x axis
        svg.append("text")
            .attr("transform",
                "translate(" + (width / 2) + " ," +
                (height + margin.bottom + margin.top) + ")")
            .style("text-anchor", "middle")
            .attr("font-weight", "bold")
            .text("Time (min)");

        // text label for the y axis
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0) // - margin.left)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .attr("font-weight", "bold")
            .text("Utilization (%)");

        // text title
        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 30) // - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "24px")
            .attr("font-weight", "bold")
            .style("text-decoration", "underline")
            .text(json.operatorName[0] + " Workload");

        // mouseover tips
		svg.selectAll("rect")
			.on("mouseover", function(d, i){
                if (i>=49*3) return;    // skip for legends...
                //console.log(d, i, i/49, data[i%49]);

				d3.select(this).attr("stroke","blue").attr("stroke-width",0.8);
				div.transition()
	                .duration(200)
	                .style("opacity", .9);

	            div.html("Task: " + keys[parseInt(i/49)] + "<br> Mean Utilization: "+((d[1]-d[0]) * 100).toFixed(2) + "%<br> Total Utilization: " + (data[i%49]["total"] * 100).toFixed(2) + "%")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                    //.style("left", (window.pageXOffset + matrix.e + 15) + "px")
                    //.style("top", (window.pageYOffset + matrix.f - 30) + "px");;
			})
			.on("mouseout", function(d) {
				d3.select(this).attr("stroke","pink").attr("stroke-width",0.2);
	            div.transition()
	                .duration(500)
	                .style("opacity", 0);
			});
    });
</script>

<script>
    var width = 960;
    var height = 450;
    var barWidth = 30;

    var width = width - margin.left - margin.right,
        height = height - margin.top - margin.bottom;

    var totalWidth = width + margin.left + margin.right;
    var totalheight = height + margin.top + margin.bottom;

    // parse json file into groupCounts
    var groupCounts = {};
    var globalCounts = [];
    d3.json("data.json").then(function(json) {
        //json.operatorName;
        for (var i = 0; i < json.averageUtilization.length; i++) {
            var key = json.operatorName[i];
            groupCounts[key] = json.averageUtilization[i];
            globalCounts = globalCounts.concat(json.averageUtilization[i]);
        }
        //console.log("GroupCounts ", groupCounts);
        //console.log("GlobalCounts ", globalCounts);


        // Sort group counts so quantile methods work
        for (var key in groupCounts) {
            var groupCount = groupCounts[key];
            groupCounts[key] = groupCount.sort(sortNumber);
        }

        // Setup a color scale for filling each box
        var colorScale = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(Object.keys(groupCounts));

        // Prepare the data for the box plots
        var boxPlotData = [];
        for (var [key, groupCount] of Object.entries(groupCounts)) {

            var record = {};
            var localMin = d3.min(groupCount);
            var localMax = d3.max(groupCount);

            record["key"] = key;
            record["counts"] = groupCount;
            record["quartile"] = boxQuartiles(groupCount);
            record["whiskers"] = [localMin, localMax];
            record["color"] = colorScale(key);

            boxPlotData.push(record);
        }

        // Compute an ordinal xScale for the keys in boxPlotData
        var xScale = d3.scalePoint()
            .domain(Object.keys(groupCounts))
            .rangeRound([0, width])
            .padding([0.5]);

        // Compute a global y scale based on the global counts
        var min = d3.min(globalCounts);
        var max = d3.max(globalCounts);
        var yScale = d3.scaleLinear()
            .domain([min - 0.0001, max])
            .range([height, 0]);

        // Setup the svg and group we will draw the box plot in
        var svg = d3.select("body").append("svg")
            .attr("width", totalWidth)
            .attr("height", totalheight)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Move the left axis over 25 pixels, and the top axis over 35 pixels
        var axisG = svg.append("g").attr("transform", "translate(25,0)");
        var axisBG = svg.append("g").attr("transform", "translate(35," + (height ) + ")");

        // Setup the group the box plot elements will render in
        var g = svg.append("g")
            .attr("transform", "translate(20,5)");

        // Draw the box plot vertical lines
        var verticalLines = g.selectAll(".verticalLines")
            .data(boxPlotData)
            .enter()
            .append("line")
            .attr("x1", function(datum) {
                return xScale(datum.key) + barWidth / 2;
            })
            .attr("y1", function(datum) {
                var whisker = datum.whiskers[0];
                return yScale(whisker);
            })
            .attr("x2", function(datum) {
                return xScale(datum.key) + barWidth / 2;
            })
            .attr("y2", function(datum) {
                var whisker = datum.whiskers[1];
                return yScale(whisker);
            })
            .attr("stroke", "#000")
            .attr("stroke-width", 1)
            .attr("fill", "none");

        // Draw the boxes of the box plot, filled in white and on top of vertical lines
        var rects = g.selectAll("rect")
            .data(boxPlotData)
            .enter()
            .append("rect")
            .attr("width", barWidth)
            .attr("height", function(datum) {
                var quartiles = datum.quartile;
                var height = yScale(quartiles[0]) - yScale(quartiles[2]);
                return height;
            })
            .attr("x", function(datum) {
                return xScale(datum.key);
            })
            .attr("y", function(datum) {
                return yScale(datum.quartile[2]);
            })
            .attr("fill", function(datum) {
                return datum.color;
            })
            .attr("stroke", "#000")
            .attr("stroke-width", 1);

        g.selectAll("rect")
			.on("mouseover", function(d, i){
                //console.log(d, i);
				d3.select(this).attr("stroke","blue").attr("stroke-width",0.8);
				div.transition()
	                .duration(200)
	                .style("opacity", .9);

	            div.html("Group: " + d.key +
                        "<br/>Max: " + d.whiskers[1].toFixed(4) +
                        "<br/>Q3: " + d.quartile[2].toFixed(4) +
                        "<br/>Median: " + d.quartile[1].toFixed(4) +
                        "<br/>Q1: " + d.quartile[0].toFixed(4) +
                        "<br/>Min: " + d.whiskers[0].toFixed(4) )
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
                    //.style("left", (window.pageXOffset + matrix.e + 15) + "px")
                    //.style("top", (window.pageYOffset + matrix.f - 30) + "px");;
			})
			.on("mouseout", function(d) {
				d3.select(this).attr("stroke","pink").attr("stroke-width",0.2);
	            div.transition()
	                .duration(500)
	                .style("opacity", 0);
			})
            .on("click", function(d) {
                //console.log("open Modal");
                $('#stackedBC').modal();
            });

        // Now render all the horizontal lines at once - the whiskers and the median
        var horizontalLineConfigs = [
            // Top whisker
            {
                x1: function(datum) {
                    return xScale(datum.key)
                },
                y1: function(datum) {
                    return yScale(datum.whiskers[0])
                },
                x2: function(datum) {
                    return xScale(datum.key) + barWidth
                },
                y2: function(datum) {
                    return yScale(datum.whiskers[0])
                }
            },
            // Median line
            {
                x1: function(datum) {
                    return xScale(datum.key)
                },
                y1: function(datum) {
                    return yScale(datum.quartile[1])
                },
                x2: function(datum) {
                    return xScale(datum.key) + barWidth
                },
                y2: function(datum) {
                    return yScale(datum.quartile[1])
                }
            },
            // Bottom whisker
            {
                x1: function(datum) {
                    return xScale(datum.key)
                },
                y1: function(datum) {
                    return yScale(datum.whiskers[1])
                },
                x2: function(datum) {
                    return xScale(datum.key) + barWidth
                },
                y2: function(datum) {
                    return yScale(datum.whiskers[1])
                }
            }
        ];

        for (var i = 0; i < horizontalLineConfigs.length; i++) {
            var lineConfig = horizontalLineConfigs[i];

            // Draw the whiskers at the min for this series
            var horizontalLine = g.selectAll(".whiskers")
                .data(boxPlotData)
                .enter()
                .append("line")
                .attr("x1", lineConfig.x1)
                .attr("y1", lineConfig.y1)
                .attr("x2", lineConfig.x2)
                .attr("y2", lineConfig.y2)
                .attr("stroke", "#000")
                .attr("stroke-width", 1)
                .attr("fill", "none");
        }

        // Setup a scale on the left
        var axisLeft = d3.axisLeft(yScale);
        axisG.append("g")
            .call(axisLeft);

        // Setup a series axis on the bottom
        var axisBottom = d3.axisBottom(xScale);
        axisBG.append("g")
            .call(axisBottom);

        // text label for the x axis
        svg.append("text")
            .attr("transform",
                "translate(" + (width / 2) + " ," +
                (height + margin.bottom - 10) + ")")
            .style("text-anchor", "middle")
            .attr("font-weight", "bold")
            .text("Operator Name");

        // text label for the y axis
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", -50) // - margin.left)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .attr("font-weight", "bold")
            .text("Average Utilization (%)");

        function boxQuartiles(d) {
            return [
                d3.quantile(d, .25),
                d3.quantile(d, .5),
                d3.quantile(d, .75)
            ];
        }

        // Perform a numeric sort on an array
        function sortNumber(a, b) {
            return a - b;
        }
    });
</script>
</body>
</html>
